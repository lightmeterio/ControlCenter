variables:
  SAST_DEFAULT_ANALYZERS: "gosec,secrets"
  GO111MODULE: "on"

stages:
  - test
  - security
  - build
  - acceptance-test
  - package
  - publish
  - docker

.on-non-tag:
  rules:
    - if: '$CI_MERGE_REQUEST_EVENT_TYPE == "detached"'
      when: never
    - if: '$CI_COMMIT_TAG == null'
      when: always
    - if: '$CI_MERGE_REQUEST_EVENT_TYPE != null && $CI_MERGE_REQUEST_EVENT_TYPE != "detached"'
      when: always

.go-builder:
  extends: .on-non-tag
  image: registry.gitlab.com/lightmeter/golang-builder-docker-image:latest

build:
  extends: .go-builder
  stage: build
  needs: []
  script:
    - make static_release
  artifacts:
    paths:
      - ./lightmeter
    expire_in: 7 days

publish-binaries2:
  image: curlimages/curl:latest
  stage: package
  needs:
    - build
  dependencies:
    - build
  rules:
    - if: '$CI_COMMIT_REF_NAME == "feature/binary-on-gitlab"'
      when: manual
  script:
    - ./ci/publish_binaries.sh
